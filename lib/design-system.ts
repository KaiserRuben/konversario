// Emotion to visual mapping - comprehensive based on actual conversation data
export const emotionVisualMap = {
    // German emotions
    'freundlich': {
        particleColor: '#fbbf24',
        glowIntensity: 0.3,
        textWeight: 400,
        animationSpeed: 1,
        particleBehavior: 'orbit'
    },
    'nachdenklich': {
        particleColor: '#3b82f6',
        glowIntensity: 0.2,
        textWeight: 300,
        animationSpeed: 0.5,
        particleBehavior: 'float'
    },
    'ernst': {
        particleColor: '#6b7280',
        glowIntensity: 0,
        textWeight: 600,
        animationSpeed: 0.3,
        particleBehavior: 'static'
    },
    'offen': {
        particleColor: '#10b981',
        glowIntensity: 0.25,
        textWeight: 400,
        animationSpeed: 0.8,
        particleBehavior: 'drift'
    },
    'analytisch': {
        particleColor: '#06b6d4',
        glowIntensity: 0.15,
        textWeight: 450,
        animationSpeed: 0.6,
        particleBehavior: 'orbit'
    },
    'würdevoll': {
        particleColor: '#7c3aed',
        glowIntensity: 0.35,
        textWeight: 500,
        animationSpeed: 0.4,
        particleBehavior: 'float'
    },
    'dominant': {
        particleColor: '#dc2626',
        glowIntensity: 0.4,
        textWeight: 600,
        animationSpeed: 0.3,
        particleBehavior: 'static'
    },
    'begeisterung': {
        particleColor: '#f59e0b',
        glowIntensity: 0.5,
        textWeight: 500,
        animationSpeed: 1.5,
        particleBehavior: 'burst'
    },
    'friedlich': {
        particleColor: '#86efac',
        glowIntensity: 0.1,
        textWeight: 300,
        animationSpeed: 0.3,
        particleBehavior: 'drift'
    },
    'neugierig': {
        particleColor: '#fbbf24',
        glowIntensity: 0.3,
        textWeight: 400,
        animationSpeed: 1.2,
        particleBehavior: 'spiral'
    },
    'kalt': {
        particleColor: '#94a3b8',
        glowIntensity: 0.05,
        textWeight: 500,
        animationSpeed: 0.2,
        particleBehavior: 'static'
    },
    'wut': {
        particleColor: '#ef4444',
        glowIntensity: 0.6,
        textWeight: 700,
        animationSpeed: 2,
        particleBehavior: 'burst'
    },
    'ruhig': {
        particleColor: '#60a5fa',
        glowIntensity: 0.1,
        textWeight: 350,
        animationSpeed: 0.4,
        particleBehavior: 'float'
    },
    'bestimmt': {
        particleColor: '#a855f7',
        glowIntensity: 0.3,
        textWeight: 500,
        animationSpeed: 0.8,
        particleBehavior: 'orbit'
    },
    'fragend': {
        particleColor: '#22d3ee',
        glowIntensity: 0.2,
        textWeight: 350,
        animationSpeed: 1,
        particleBehavior: 'spiral'
    },
    'vorsichtig': {
        particleColor: '#fde047',
        glowIntensity: 0.15,
        textWeight: 350,
        animationSpeed: 0.5,
        particleBehavior: 'drift'
    },

    // English emotions
    'thoughtful': {
        particleColor: '#3b82f6',
        glowIntensity: 0.2,
        textWeight: 300,
        animationSpeed: 0.5,
        particleBehavior: 'float'
    },
    'excited': {
        particleColor: '#f59e0b',
        glowIntensity: 0.5,
        textWeight: 500,
        animationSpeed: 1.5,
        particleBehavior: 'burst'
    },
    'contemplative': {
        particleColor: '#8b5cf6',
        glowIntensity: 0.15,
        textWeight: 350,
        animationSpeed: 0.4,
        particleBehavior: 'spiral'
    },
    'curious': {
        particleColor: '#fbbf24',
        glowIntensity: 0.3,
        textWeight: 400,
        animationSpeed: 1.2,
        particleBehavior: 'spiral'
    },
    'passionate': {
        particleColor: '#ec4899',
        glowIntensity: 0.45,
        textWeight: 500,
        animationSpeed: 1.3,
        particleBehavior: 'burst'
    },
    'reflective': {
        particleColor: '#6366f1',
        glowIntensity: 0.2,
        textWeight: 350,
        animationSpeed: 0.5,
        particleBehavior: 'float'
    },
    'amused': {
        particleColor: '#84cc16',
        glowIntensity: 0.25,
        textWeight: 400,
        animationSpeed: 1,
        particleBehavior: 'orbit'
    },
    'eager': {
        particleColor: '#fb923c',
        glowIntensity: 0.35,
        textWeight: 450,
        animationSpeed: 1.4,
        particleBehavior: 'burst'
    },
    'alert': {
        particleColor: '#eab308',
        glowIntensity: 0.3,
        textWeight: 450,
        animationSpeed: 1.1,
        particleBehavior: 'orbit'
    },
    'ready': {
        particleColor: '#22c55e',
        glowIntensity: 0.25,
        textWeight: 450,
        animationSpeed: 1,
        particleBehavior: 'static'
    },
    'restless': {
        particleColor: '#f97316',
        glowIntensity: 0.35,
        textWeight: 400,
        animationSpeed: 1.6,
        particleBehavior: 'drift'
    },
    'warm': {
        particleColor: '#fb7185',
        glowIntensity: 0.3,
        textWeight: 400,
        animationSpeed: 0.8,
        particleBehavior: 'float'
    },
    'enthusiastic': {
        particleColor: '#f59e0b',
        glowIntensity: 0.5,
        textWeight: 500,
        animationSpeed: 1.5,
        particleBehavior: 'burst'
    },
    'animated': {
        particleColor: '#a78bfa',
        glowIntensity: 0.4,
        textWeight: 450,
        animationSpeed: 1.4,
        particleBehavior: 'spiral'
    },
    'engaged': {
        particleColor: '#2dd4bf',
        glowIntensity: 0.3,
        textWeight: 400,
        animationSpeed: 1,
        particleBehavior: 'orbit'
    },
    'determined': {
        particleColor: '#7c3aed',
        glowIntensity: 0.35,
        textWeight: 500,
        animationSpeed: 0.8,
        particleBehavior: 'static'
    },
    'gentle': {
        particleColor: '#c7d2fe',
        glowIntensity: 0.15,
        textWeight: 300,
        animationSpeed: 0.4,
        particleBehavior: 'float'
    },
    'intense': {
        particleColor: '#dc2626',
        glowIntensity: 0.5,
        textWeight: 600,
        animationSpeed: 1.2,
        particleBehavior: 'burst'
    },
    'melancholy': {
        particleColor: '#64748b',
        glowIntensity: 0.1,
        textWeight: 300,
        animationSpeed: 0.3,
        particleBehavior: 'drift'
    },
    'wonder': {
        particleColor: '#c084fc',
        glowIntensity: 0.35,
        textWeight: 350,
        animationSpeed: 0.7,
        particleBehavior: 'spiral'
    },
    'anxious': {
        particleColor: '#facc15',
        glowIntensity: 0.25,
        textWeight: 400,
        animationSpeed: 1.8,
        particleBehavior: 'drift'
    },
    'focused': {
        particleColor: '#0ea5e9',
        glowIntensity: 0.2,
        textWeight: 450,
        animationSpeed: 0.6,
        particleBehavior: 'orbit'
    },
    'attentive': {
        particleColor: '#14b8a6',
        glowIntensity: 0.25,
        textWeight: 400,
        animationSpeed: 0.8,
        particleBehavior: 'static'
    },
    'welcoming': {
        particleColor: '#4ade80',
        glowIntensity: 0.3,
        textWeight: 400,
        animationSpeed: 0.9,
        particleBehavior: 'float'
    },
    'open': {
        particleColor: '#2dd4bf',
        glowIntensity: 0.25,
        textWeight: 400,
        animationSpeed: 0.8,
        particleBehavior: 'drift'
    },
    'probing': {
        particleColor: '#818cf8',
        glowIntensity: 0.2,
        textWeight: 400,
        animationSpeed: 1,
        particleBehavior: 'spiral'
    },

    // Physical gestures mapped to emotions
    'leaning': {
        particleColor: '#f472b6',
        glowIntensity: 0.25,
        textWeight: 400,
        animationSpeed: 0.9,
        particleBehavior: 'orbit'
    },
    'gesturing': {
        particleColor: '#fbbf24',
        glowIntensity: 0.3,
        textWeight: 400,
        animationSpeed: 1.1,
        particleBehavior: 'spiral'
    },
    'smile': {
        particleColor: '#fde047',
        glowIntensity: 0.35,
        textWeight: 400,
        animationSpeed: 1,
        particleBehavior: 'float'
    },
    'lächeln': {
        particleColor: '#fde047',
        glowIntensity: 0.35,
        textWeight: 400,
        animationSpeed: 1,
        particleBehavior: 'float'
    },
    'twinkle': {
        particleColor: '#e879f9',
        glowIntensity: 0.4,
        textWeight: 350,
        animationSpeed: 1.3,
        particleBehavior: 'burst'
    },
    'furrow': {
        particleColor: '#94a3b8',
        glowIntensity: 0.15,
        textWeight: 450,
        animationSpeed: 0.5,
        particleBehavior: 'static'
    },

    // Default
    'neutral': {
        particleColor: '#9ca3af',
        glowIntensity: 0.1,
        textWeight: 400,
        animationSpeed: 0.8,
        particleBehavior: 'drift'
    },
    'speaking': {
        particleColor: '#a1a1aa',
        glowIntensity: 0.1,
        textWeight: 400,
        animationSpeed: 0.7,
        particleBehavior: 'drift'
    }
} as const;

// Extract emotion from text - handles complex emotion descriptions
export function extractEmotion(emotionText: string): keyof typeof emotionVisualMap {
    if (!emotionText) return 'neutral';

    const text = emotionText.toLowerCase();

    // Direct match first (for single words)
    for (const key of Object.keys(emotionVisualMap)) {
        if (text.includes(key)) {
            return key as keyof typeof emotionVisualMap;
        }
    }

    // Extended keyword matching for complex descriptions
    // German patterns
    if (text.includes('freundlich') || text.includes('lächel')) return 'freundlich';
    if (text.includes('nachdenklich') || text.includes('denk')) return 'nachdenklich';
    if (text.includes('ernst') || text.includes('serious')) return 'ernst';
    if (text.includes('begeister') || text.includes('enthusias')) return 'begeisterung';
    if (text.includes('kalt') || text.includes('ruhig') || text.includes('calm')) return 'ruhig';
    if (text.includes('neugierig') || text.includes('curious')) return 'neugierig';
    if (text.includes('wut') || text.includes('anger') || text.includes('kalt')) return 'wut';
    if (text.includes('vorsichtig') || text.includes('careful')) return 'vorsichtig';
    if (text.includes('würdevoll') || text.includes('dignified')) return 'würdevoll';
    if (text.includes('dominant') || text.includes('commanding')) return 'dominant';
    if (text.includes('friedlich') || text.includes('peaceful')) return 'friedlich';
    if (text.includes('analytisch') || text.includes('analytical')) return 'analytisch';
    if (text.includes('offen') || text.includes('open')) return 'open';
    if (text.includes('bestimmt') || text.includes('determined')) return 'determined';
    if (text.includes('fragend') || text.includes('questioning')) return 'fragend';

    // English patterns
    if (text.includes('thought') || text.includes('ponder')) return 'thoughtful';
    if (text.includes('excit') || text.includes('animated')) return 'excited';
    if (text.includes('contemplat')) return 'contemplative';
    if (text.includes('passionate') || text.includes('passion')) return 'passionate';
    if (text.includes('reflect')) return 'reflective';
    if (text.includes('amused') || text.includes('amusing')) return 'amused';
    if (text.includes('eager')) return 'eager';
    if (text.includes('alert') || text.includes('ready')) return 'alert';
    if (text.includes('restless') || text.includes('anxious')) return 'restless';
    if (text.includes('warm') || text.includes('welcoming')) return 'warm';
    if (text.includes('gentle') || text.includes('soft')) return 'gentle';
    if (text.includes('intense') || text.includes('intensity')) return 'intense';
    if (text.includes('melanchol') || text.includes('sad')) return 'melancholy';
    if (text.includes('wonder') || text.includes('awe')) return 'wonder';
    if (text.includes('focus') || text.includes('koncentr')) return 'focused';
    if (text.includes('attentive') || text.includes('aufmerksam')) return 'attentive';
    if (text.includes('probe') || text.includes('probing')) return 'probing';

    // Physical gestures that indicate emotion
    if (text.includes('lean') || text.includes('forward')) return 'leaning';
    if (text.includes('gestur') || text.includes('hand')) return 'gesturing';
    if (text.includes('smile') || text.includes('lächel')) return 'smile';
    if (text.includes('twinkl') || text.includes('gleam')) return 'twinkle';
    if (text.includes('furrow') || text.includes('frown')) return 'furrow';

    // Compound emotions - pick the most prominent
    if (text.includes('cold') && text.includes('anger')) return 'kalt';
    if (text.includes('warm') && text.includes('smile')) return 'warm';
    if (text.includes('sharp') || text.includes('piercing')) return 'intense';

    return 'neutral';
}

// Generate consistent hash from string
export function stringToHash(str: string): number {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return Math.abs(hash);
}

// Personality-based typography
export function getPersonalityStyles(name: string) {
    const hash = stringToHash(name);

    // Use hash to generate consistent but varied styles
    const letterSpacing = -0.02 + (hash % 10) * 0.004; // -0.02 to 0.02
    const fontWeight = 300 + (hash % 5) * 100; // 300 to 700
    const baselineShift = (hash % 7) - 3; // -3 to 3 pixels
    const fontStyle = hash % 3 === 0 ? 'italic' : 'normal';

    return {
        letterSpacing: `${letterSpacing}em`,
        fontWeight,
        transform: `translateY(${baselineShift}px)`,
        fontStyle,
    };
}

// Conversation momentum to animation speed
export const momentumMap = {
    'sustained': { animSpeed: 1, particleLife: 5000, blur: 0.5 },
    'building': { animSpeed: 1.5, particleLife: 3000, blur: 0.3 },
    'waning': { animSpeed: 0.5, particleLife: 8000, blur: 0.8 },
    'static': { animSpeed: 0.3, particleLife: 10000, blur: 1 }
};

// Depth mapping for visual complexity
export const depthMap = {
    'surface': {
        layers: 1,
        particleOpacity: 0.3,
        textOpacity: 0.9,
        glowSize: 10
    },
    'accessible': {
        layers: 2,
        particleOpacity: 0.5,
        textOpacity: 0.95,
        glowSize: 20
    },
    'deep': {
        layers: 3,
        particleOpacity: 0.7,
        textOpacity: 1,
        glowSize: 30
    }
};

// Time-based atmosphere
export function getTimeBasedAtmosphere() {
    const hour = new Date().getHours();

    if (hour >= 5 && hour < 9) {
        return {
            name: 'morning',
            hue: 200, // Cool blue
            saturation: 0.1,
            lightness: 0.96,
            particleSpeed: 0.5
        };
    } else if (hour >= 9 && hour < 17) {
        return {
            name: 'day',
            hue: 0,
            saturation: 0,
            lightness: 0.98,
            particleSpeed: 1
        };
    } else if (hour >= 17 && hour < 21) {
        return {
            name: 'evening',
            hue: 30, // Warm orange
            saturation: 0.15,
            lightness: 0.94,
            particleSpeed: 0.7
        };
    } else {
        return {
            name: 'night',
            hue: 250, // Deep purple
            saturation: 0.2,
            lightness: 0.08,
            particleSpeed: 0.3
        };
    }
}

// Message age to opacity
export function getMessageOpacity(timestamp: number): number {
    const age = Date.now() - timestamp;
    const minutes = age / (1000 * 60);

    if (minutes < 1) return 1;
    if (minutes < 5) return 0.95;
    if (minutes < 15) return 0.85;
    if (minutes < 30) return 0.75;
    return 0.65;
}

// Parse metadata safely
export function parseMetadata(metadata: string | undefined | null) {
    if (!metadata) return {};

    try {
        return typeof metadata === 'string' ? JSON.parse(metadata) : metadata;
    } catch {
        return {};
    }
}

// Extract manner/delivery style for additional visual cues
export function extractManner(mannerText: string): {
    speed: number;
    emphasis: number;
    rhythm: 'steady' | 'varied' | 'staccato' | 'flowing';
} {
    if (!mannerText) return { speed: 1, emphasis: 1, rhythm: 'steady' };

    const text = mannerText.toLowerCase();

    let speed = 1;
    let emphasis = 1;
    let rhythm: 'steady' | 'varied' | 'staccato' | 'flowing' = 'steady';

    // Speed indicators
    if (text.includes('quick') || text.includes('fast') || text.includes('rapid')) speed = 1.5;
    if (text.includes('slow') || text.includes('measured') || text.includes('deliberate')) speed = 0.7;
    if (text.includes('pause') || text.includes('hesitat')) speed = 0.5;

    // Emphasis indicators
    if (text.includes('emphatic') || text.includes('strong') || text.includes('firm')) emphasis = 1.3;
    if (text.includes('soft') || text.includes('gentle') || text.includes('quiet')) emphasis = 0.8;
    if (text.includes('whisper') || text.includes('murmur')) emphasis = 0.6;
    if (text.includes('shout') || text.includes('exclaim')) emphasis = 1.5;

    // Rhythm patterns
    if (text.includes('flowing') || text.includes('smooth')) rhythm = 'flowing';
    if (text.includes('staccato') || text.includes('sharp') || text.includes('abrupt')) rhythm = 'staccato';
    if (text.includes('varied') || text.includes('dynamic')) rhythm = 'varied';

    return { speed, emphasis, rhythm };
}

// Generate particle configuration from metadata
export function getParticleConfig(metadata: any, conversationStage?: any) {
    const emotion = extractEmotion(metadata?.emotion || '');
    const visual = emotionVisualMap[emotion];
    const momentum = conversationStage?.momentum || 'sustained';
    const depth = conversationStage?.suggestedDepth || 'accessible';

    return {
        count: depth === 'deep' ? 300 : depth === 'accessible' ? 250 : 200,
        color: visual.particleColor,
        behavior: visual.particleBehavior,
        speed: momentumMap[momentum as keyof typeof momentumMap]?.animSpeed || 1,
        opacity: depthMap[depth as keyof typeof depthMap]?.particleOpacity || 0.5,
        lifetime: momentumMap[momentum as keyof typeof momentumMap]?.particleLife || 5000
    };
}

// Calculate message importance based on all metadata
export function getMessageImportance(message: any): number {
    const metadata = parseMetadata(message.metadata);
    const stage = parseMetadata(message.conversationStage);
    const modulation = parseMetadata(message.responseModulation);

    let importance = 0.5; // Base importance

    // Adjust based on metadata
    if (metadata.internalThought) importance += 0.1;
    if (metadata.subtext) importance += 0.1;
    if (metadata.emotion && metadata.emotion.length > 50) importance += 0.05; // Complex emotions

    // Stage-based adjustments
    if (stage?.suggestedDepth === 'deep') importance += 0.2;
    if (stage?.suggestedDepth === 'moderate') importance += 0.1;
    if (stage?.userState === 'engaged' || stage?.userState === 'philosophical') importance += 0.15;
    if (stage?.momentum === 'building') importance += 0.1;

    // Modulation-based adjustments
    if (modulation?.priority === 'clarity') importance += 0.15;
    if (modulation?.depth === 'philosophical') importance += 0.1;
    if (modulation?.targetLength === 'extended') importance += 0.05;

    // Author type adjustments
    if (message.authorType === 'user') importance += 0.1;
    if (message.authorType === 'system') importance -= 0.2;

    return Math.min(importance, 1);
}

// Map conversation stage to atmosphere intensity
export function getStageAtmosphere(stage: any): {
    intensity: number;
    blur: number;
    particleDensity: number;
} {
    if (!stage) return { intensity: 0.5, blur: 0.5, particleDensity: 0.5 };

    const userState = stage.userState || 'casual';
    const momentum = stage.momentum || 'sustained';
    const depth = stage.suggestedDepth || 'surface';

    // Map user states to atmosphere
    const stateMap: Record<string, number> = {
        'casual': 0.3,
        'exploring': 0.5,
        'engaged': 0.7,
        'philosophical': 0.9,
        'confused': 0.4
    };

    // Map momentum to particle density
    const momentumDensity: Record<string, number> = {
        'building': 0.8,
        'sustained': 0.6,
        'shifting': 0.7,
        'waning': 0.3
    };

    // Map depth to blur
    const depthBlur: Record<string, number> = {
        'surface': 0.2,
        'moderate': 0.5,
        'accessible': 0.5,
        'deep': 0.8,
        'full': 1
    };

    return {
        intensity: stateMap[userState] || 0.5,
        blur: depthBlur[depth] || 0.5,
        particleDensity: momentumDensity[momentum] || 0.5
    };
}

// CSS variable generator for dynamic theming
export function generateCSSVariables(theme: ReturnType<typeof getTimeBasedAtmosphere>) {
    return {
        '--atmosphere-hue': theme.hue,
        '--atmosphere-saturation': `${theme.saturation * 100}%`,
        '--atmosphere-lightness': `${theme.lightness * 100}%`,
        '--particle-speed': theme.particleSpeed,
        '--bg-gradient': `radial-gradient(
      ellipse at center,
      hsl(${theme.hue}, ${theme.saturation * 100}%, ${theme.lightness * 100}%),
      hsl(${theme.hue}, ${theme.saturation * 50}%, ${theme.lightness * 90}%)
    )`
    };
}

// Parse effect descriptions to visual changes
export function parseEffect(effectText: string): {
    atmosphereShift?: string;
    tensionChange: number; // -1 to 1, where negative reduces tension
    energyShift: number; // -1 to 1, where negative calms
} {
    if (!effectText) return { tensionChange: 0, energyShift: 0 };

    const text = effectText.toLowerCase();

    let tensionChange = 0;
    let energyShift = 0;
    let atmosphereShift;

    // Tension indicators
    if (text.includes('tension') && text.includes('ris')) tensionChange = 0.3;
    if (text.includes('tension') && text.includes('eas')) tensionChange = -0.3;
    if (text.includes('settles') || text.includes('calm')) tensionChange = -0.2;
    if (text.includes('intensif') || text.includes('heighten')) tensionChange = 0.4;

    // Energy indicators
    if (text.includes('energy') || text.includes('jolt')) energyShift = 0.5;
    if (text.includes('quiet') || text.includes('still')) energyShift = -0.3;
    if (text.includes('hum') || text.includes('vibrat')) energyShift = 0.2;
    if (text.includes('contemplat') || text.includes('reflect')) energyShift = -0.1;

    // Atmosphere shifts
    if (text.includes('deeper')) atmosphereShift = 'deepening';
    if (text.includes('lighter')) atmosphereShift = 'lightening';
    if (text.includes('shift')) atmosphereShift = 'shifting';

    return { atmosphereShift, tensionChange, energyShift };
}

// Combine all metadata to get comprehensive visual state
export function getComprehensiveVisualState(message: any) {
    const metadata = parseMetadata(message.metadata);
    const stage = parseMetadata(message.conversationStage);
    const modulation = parseMetadata(message.responseModulation);

    const emotion = extractEmotion(metadata?.emotion || '');
    const emotionVisual = emotionVisualMap[emotion];
    const manner = extractManner(metadata?.manner || metadata?.delivery || '');
    const effect = parseEffect(metadata?.effect || '');
    const stageAtmosphere = getStageAtmosphere(stage);
    const importance = getMessageImportance(message);

    return {
        // Emotion-based
        particleColor: emotionVisual.particleColor,
        particleBehavior: emotionVisual.particleBehavior,
        glowIntensity: emotionVisual.glowIntensity,

        // Text presentation
        textWeight: emotionVisual.textWeight,
        textSpeed: manner.speed * emotionVisual.animationSpeed,
        textEmphasis: manner.emphasis,
        textRhythm: manner.rhythm,
        fontSize: 0.875 + importance * 0.25,

        // Atmosphere
        atmosphereIntensity: stageAtmosphere.intensity,
        atmosphereBlur: stageAtmosphere.blur,
        particleDensity: stageAtmosphere.particleDensity,

        // Effects
        tensionLevel: effect.tensionChange,
        energyLevel: effect.energyShift,
        atmosphereShift: effect.atmosphereShift,

        // Metadata flags
        hasInternalThought: !!metadata?.internalThought,
        hasSubtext: !!metadata?.subtext,
        hasGesture: !!metadata?.gesture,

        // Overall importance
        importance
    };
}